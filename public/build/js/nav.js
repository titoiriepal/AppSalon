let paso=1;const pasoInicial=1,pasoFinal=3;let dia="";var tablaFech={};const cita={usuarioId:"",nombre:"",fecha:"",hora:"",servicios:[]};function iniciarApp(){tabs(),botonesPaginador(),siguientePagina(),anteriorPagina(),consultarAPI(),identificarCliente(),seleccionarFecha(),seleccionarHora(),mostrarResumen()}function mostrarSeccion(){document.querySelector(".mostrar").classList.remove("mostrar");document.querySelector("#paso-"+paso).classList.add("mostrar");document.querySelector(".actual").classList.remove("actual");document.querySelector(`[data-paso="${paso}"]`).classList.add("actual")}function tabs(){document.querySelectorAll(".tabs button").forEach(e=>{e.addEventListener("click",(function(e){paso=parseInt(e.target.dataset.paso),mostrarSeccion(),botonesPaginador()}))})}function botonesPaginador(){const e=document.querySelector("#anterior"),t=document.querySelector("#siguiente");1===paso?(e.classList.add("ocultar"),t.classList.remove("ocultar")):3===paso?(e.classList.remove("ocultar"),t.classList.add("ocultar"),mostrarResumen()):(t.classList.remove("ocultar"),e.classList.remove("ocultar"))}function siguientePagina(){document.querySelector("#siguiente").addEventListener("click",(function(){paso<3&&(paso++,mostrarSeccion(),botonesPaginador())}))}function anteriorPagina(){document.querySelector("#anterior").addEventListener("click",(function(){paso>1&&(paso--,mostrarSeccion(),botonesPaginador())}))}async function consultarAPI(){try{const e=location.origin+"/api/servicios",t=await fetch(e);mostrarServicios(await t.json())}catch(e){console.log(e)}}function mostrarServicios(e){e.forEach(e=>{const{id:t,nombre:a,precio:o}=e,n=document.createElement("P");n.classList.add("nombre-servicio"),n.textContent=a;const r=document.createElement("P");r.classList.add("precio-servicio"),r.textContent=o+" €";const c=document.createElement("DIV");c.classList.add("servicio"),c.dataset.idServicio=t,c.onclick=function(){seleccionarServicio(e)},c.appendChild(n),c.appendChild(r),document.querySelector("#servicios").appendChild(c)})}function seleccionarServicio(e){const{id:t}=e,{servicios:a}=cita,o=document.querySelector(`[data-id-servicio ="${t}"]`);a.some(e=>e.id===t)?cita.servicios=a.filter(e=>e.id!==t):cita.servicios=[...a,e],o.classList.toggle("seleccionado")}function identificarCliente(){cita.nombre=document.querySelector("#nombre").value,cita.usuarioId=document.querySelector("#usuarioId").value.toString()}async function seleccionarFecha(){document.querySelector("#fecha").addEventListener("input",(function(e){fecha=new Date(e.target.value),fecha=fecha.toLocaleDateString("fr-CA"),Object.keys(tablaFech).includes(fecha)?mostrarHorarios():conseguirFechas(fecha).then(e=>{tablaFech=e,mostrarHorarios()})}))}function mostrarHorarios(){const e=document.querySelector("#work-hours"),t=document.querySelector("#fecha");var a="";fecha=new Date(t.value),dia=fecha.getUTCDay(),fechaFormateada=fecha.toLocaleDateString("fr-CA");const o=["09:00:00","09:15:00","09:30:00","09:45:00","10:00:00","10:15:00","10:30:00","10:45:00","11:00:00","11:15:00","11:30:00","11:45:00","12:00:00","12:15:00","12:30:00","12:45:00","13:00:00","13:15:00"],n=["16:30:00","16:45:00","17:00:00","17:15:00","17:30:00","17:45:00","18:00:00","18:15:00","18:30:00","18:45:00"];if([0].includes(dia))t.value="",mostrarAlerta("Cerramos Sábados por la tarde y Domingos","error",".formulario");else{if([6].includes(dia))o.filter((function(e){tablaFech[fechaFormateada].includes(e)||(a+="<option value="+e+"></option>")}));else o.filter((function(e){tablaFech[fechaFormateada].includes(e)||(a+="<option value="+e+"></option>")})),n.filter((function(e){tablaFech[fechaFormateada].includes(e)||(a+="<option value="+e+"></option>")}));e.innerHTML=a,cita.fecha=t.value}}async function conseguirFechas(e){const t=new FormData;t.append("fecha",e);try{const e=location.origin+"/api/horas-libres",a=await fetch(e,{method:"POST",body:t});return tablaFechas=await a.json(),tablaFechas}catch(e){console.log(e)}}function seleccionarHora(){const e=["00","15","30","45"];document.querySelector("#hora").addEventListener("input",(function(t){const a=t.target.value,o=a.split(":")[0],n=a.split(":")[1];o<"09"||(o>="13"&&n>"15"||o>"13")&&o<"16"||o>="18"&&n>"45"||o>="19"?(mostrarAlerta("Nuestro horario es de 09 de la mañana a 13:30 y de 16:00 a 19:00 horas","error",".formulario"),t.target.value=""):e.find(e=>e===n)?[6].includes(dia)&&("13"===o&&n>"15"||o>"13")&&(mostrarAlerta("Los Sábados abrimos de 09:00 a 13:30","error",".formulario"),t.target.value=""):(mostrarAlerta("Por favor, elige una hora válida. Aquellas que acaben en 00, 15, 30 y 45","error",".formulario"),t.target.value=""),cita.hora=t.target.value}))}function mostrarAlerta(e,t,a,o=!0){const n=document.querySelector(".alerta");n&&n.remove();const r=document.createElement("DIV");r.textContent=e,r.classList.add("alerta"),r.classList.add(t);document.querySelector(a).appendChild(r),o&&setTimeout(()=>{r.remove()},4e3)}function mostrarResumen(){const e=document.querySelector(".contenido-resumen");let t=0;for(;e.firstChild;)e.removeChild(e.firstChild);if(Object.values(cita).includes("")||0===cita.servicios.length)return void mostrarAlerta("Faltan datos de servicios, fecha u hora","error",".contenido-resumen",!1);const{nombre:a,fecha:o,hora:n,servicios:r}=cita,c=new Date(o),i=c.getMonth(),s=c.getDate(),l=c.getFullYear(),d=document.createElement("P"),u=document.createElement("P"),m=document.createElement("P"),p=new Date(Date.UTC(l,i,s)).toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"});d.innerHTML=" <span>Nombre:</span> "+a,u.innerHTML=" <span>Fecha:</span> "+p,m.innerHTML=` <span>Hora:</span> ${n} horas`;const h=document.createElement("H3");h.textContent="Datos de la cita",e.appendChild(h),e.appendChild(d),e.appendChild(u),e.appendChild(m);const f=document.createElement("H3");f.textContent="Resumen de Servicios",e.appendChild(f),r.forEach(a=>{const{id:o,precio:n,nombre:r}=a,c=document.createElement("DIV");c.classList.add("contenedor-servicio");const i=document.createElement("P");i.textContent=r;const s=document.createElement("P");s.innerHTML=`<span>Precio: </span>${n} €`,t+=parseInt(n),c.appendChild(i),c.appendChild(s),e.appendChild(c)});const v=document.createElement("P");v.innerHTML=`<span>Precio Total: </span> ${t}.00 €`,e.appendChild(v);const g=document.createElement("BUTTON");g.classList.add("boton"),g.textContent="Reservar Cita",g.onclick=reservarCita,e.appendChild(g)}async function reservarCita(){const{nombre:e,fecha:t,hora:a,servicios:o,usuarioId:n}=cita,r=o.map(e=>e.id),c=new FormData;c.append("nombre",e),c.append("fecha",t),c.append("hora",a),c.append("usuarioId",n),c.append("servicios",r);try{const e=location.origin+"/api/citas",t=await fetch(e,{method:"POST",body:c}),a=await t.json();console.log(a),a.resultado?Swal.fire({title:"GUARDADO",text:"Cita creada correctamente",icon:"success"}).then(()=>{window.location.reload()}):Swal.fire({title:"ERROR",text:a.error,icon:"error"}).then(()=>{window.location.reload()})}catch(e){Swal.fire({icon:"error",title:"ERROR",text:"No se ha podido guardar la cita correctamente",footer:e})}}document.addEventListener("DOMContentLoaded",(function(){iniciarApp()}));